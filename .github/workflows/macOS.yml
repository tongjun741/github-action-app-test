name: macOS

on:
  repository_dispatch:
    types: [macOS-start]
    
  workflow_dispatch:
    inputs:
      software_download_url:
        description: 'Download url'
        required: true
        default: 'https://dl.szdamai.com/downloads/mac_arm64_app_zh/HuaYoungApp_Mac_arm64_10.0.559_zh_setup.dmg'
      in_dev:
        description: 'æ˜¯å¦æ˜¯æµ‹è¯•ç¯å¢ƒ'
        default: 'false'
      is_arm:
        description: 'æ˜¯å¦æ˜¯ARMç‰ˆçš„å®¢æˆ·ç«¯'
        default: 'true'

jobs:

  macOS:
    runs-on: macos-latest

    steps:
      - name: Check if running on M1 chip
        run: |
          if [[ "$(sysctl -n machdep.cpu.brand_string)" == *"Apple"* ]]; then
            echo "Running on an Apple Silicon (M1) chip"
            if [ "${{ inputs.is_arm }}" == "false" ]; then
              echo "Input parameter is_arm is false, exiting workflow..."
              exit 1
            fi
          else
            echo "Running on an Intel chip"
            if [ "${{ inputs.is_arm }}" == "true" ]; then
              echo "Input parameter is_arm is true, exiting workflow..."
              exit 1
            fi
          fi

      - uses: actions/checkout@v4
      
      - name: Download file with curl
        run: |
          if [ -z "${{ inputs.software_download_url }}" ]; then
            download_url="https://dl.szdamai.com/downloads/mac_arm64_app_zh/HuaYoungApp_Mac_arm64_10.0.559_zh_setup.dmg"
          else
            download_url="${{ inputs.software_download_url }}"
          fi
          curl -o /tmp/HuaYoungApp_Mac_setup.dmg $download_url

          # æå–é“¾æ¥ä¸­çš„æ–‡ä»¶åéƒ¨åˆ†
          filename=$(basename $download_url)

          # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–ç‰ˆæœ¬å·
          version=""
          if [[ $filename =~ [0-9]+\.[0-9]+\.[0-9]+ ]]; then
              version=${BASH_REMATCH[0]}
              echo "ç‰ˆæœ¬å·: $version"
          else
              echo "æ— æ³•è§£æç‰ˆæœ¬å·"
          fi

      - name: Install software
        run: |
          hdiutil attach /tmp/HuaYoungApp_Mac_setup.dmg
          sudo cp -R '/Volumes/èŠ±æ¼¾å®¢æˆ·ç«¯ ${version}/èŠ±æ¼¾å®¢æˆ·ç«¯.app' /Applications/
          hdiutil detach '/Volumes/èŠ±æ¼¾å®¢æˆ·ç«¯ ${version}/'

      # - name: Start software
      #   run: |
      #     open /Applications/èŠ±æ¼¾å®¢æˆ·ç«¯.app

      - name: å‡†å¤‡chromedriver
        run: |
          wget https://chromedriver.storage.googleapis.com/108.0.5359.22/chromedriver_mac64.zip
          unzip chromedriver_mac64.zip
          mkdir -p /tmp/chromedriver/mac-108/chromedriver-mac-x64/
          mv chromedriver /tmp/chromedriver/mac-108/chromedriver-mac-x64/

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          #cache: 'yarn'
          
      - name: Install dependencies ğŸ‘¨ğŸ»â€ğŸ’»
        run: yarn
      
      # - name: Setup tmate session
      #   uses: mxschmitt/action-tmate@v3

      - name: E2E Test for Electron ğŸ§ª
        env:
          DEV_WDIO_PASSWORD: ${{ secrets.DEV_WDIO_PASSWORD }}
          PRODUCT_WDIO_PASSWORD: ${{ secrets.PRODUCT_WDIO_PASSWORD }}
          DOWNLOAD_URL: ${{ github.event.inputs.software_download_url }}
          IN_DEV: ${{ github.event.inputs.in_dev }}
          FEISHU_TOKEN: ${{ secrets.FEISHU_TOKEN }}
        run: yarn wdio