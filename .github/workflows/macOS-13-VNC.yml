name: macOS-13-VNC
on: 
  workflow_dispatch:
jobs:
  build:
    name: macOS-13-VNC
    runs-on: macos-13
    
    steps:                 
    # - name: Enabling Remote Access
    #   env:
    #     NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
    #   run: |
    #       curl -s -o start.sh -L "https://raw.githubusercontent.com/JohnnyNetsec/github-vm/main/mac/start.sh"
    #       chmod +x start.sh
    #       bash start.sh "$NGROK_AUTH_TOKEN"
          
    # - name: Log In Details To VNC Server
    #   run: |
    #      chmod +x login.sh
    #      bash login.sh
          
    # - name: Enable screen recording
    #   run: |
    #     curl -s -o /tmp/modify_screensharing.sh -L "https://gist.githubusercontent.com/timsutton/31344ef60dbd4d64aca5b3287c0644e8/raw/e1fb343f3fc9ac30cea5f4ee14ba7a1384499d5e/modify_screensharing.sh"
    #     sudo chmod +x /tmp/modify_screensharing.sh
    #     sudo /tmp/modify_screensharing.sh
          
    # - name: Download IE11 - Win7
    #   run: |
    #     wget https://ia601000.us.archive.org/20/items/ie11.win7.virtualbox/IE11.Win7.VirtualBox.zip
    #     unzip IE11.Win7.VirtualBox.zip
    #     sudo mv "IE11 - Win7.ova" /Users/tcv/Desktop/

    - uses: actions/checkout@v4 

    - name: Enabling Remote Access
      run: |
          chmod +x ./macOS_VNC/start.sh
          sudo ./macOS_VNC/start.sh
          
    - name: Log In Details To VNC Server
      run: |
         chmod +x ./macOS_VNC/login.sh
         sudo ./macOS_VNC/login.sh
          
    - name: Enable screen recording
      run: |
        sudo chmod +x ./macOS_VNC/modify_screensharing-13.sh
        sudo ./macOS_VNC/modify_screensharing-13.sh

    - name: å¯åŠ¨frpc
      run: |
        sed -i "" "s/user = .*/user = ${{ secrets.FRPC_USER }}/g" macOS_VNC/frpc_15897721.ini
        sed -i "" "s/remote_port = .*/remote_port = ${{ secrets.FRPC_MAC_REMOTE_PORT }}/g" macOS_VNC/frpc_15897721.ini
        sed -i "" "s/local_port = .*/local_port = 8080/g" macOS_VNC/frpc_15897721.ini
        curl -Lo frpc https://nya.globalslb.net/natfrp/client/frpc/0.51.0-sakura-9.3/frpc_darwin_amd64
        chmod +x frpc
        ./frpc -c ./macOS_VNC/frpc_15897721.ini > /tmp/frpc.log 2>&1 &
          
    - name: Install node dependencies ğŸ‘¨ğŸ»â€ğŸ’»
      run: yarn add ws express sharp pngjs

    - name: Install cliclick
      run: brew install cliclick

    - name: å¯åŠ¨wsè¿œç¨‹æ¡Œé¢
      run: |
        # ç¡®ä¿runneradminç”¨æˆ·å­˜åœ¨å¹¶åˆ‡æ¢åˆ°è¯¥ç”¨æˆ·æ‰§è¡Œå‘½ä»¤
        sudo -u runneradmin sh -c '
          node ./macOS_VNC/screenShareServer.js > /tmp/screenShareServer.log 2>&1 &
          # å¯é€‰ï¼šéªŒè¯è¿›ç¨‹æ˜¯å¦ä»¥runneradminç”¨æˆ·å¯åŠ¨
          echo "å·²å¯åŠ¨wsè¿œç¨‹æ¡Œé¢ï¼Œè¿›ç¨‹ä¿¡æ¯ï¼š"
          ps -ef | grep screenShareServer.js | grep -v grep
        '
        
    - name: Install AnyDesk
      run: |
        #!/bin/bash
        
        echo "å¼€å§‹å®‰è£… AnyDesk..."
        
        # ä¸‹è½½ AnyDesk
        echo "æ­£åœ¨ä¸‹è½½ AnyDesk..."
        ANYDESK_DMG="anydesk.dmg"
        curl -L -o "$ANYDESK_DMG" "https://download.anydesk.com/anydesk.dmg"
        
        # æŒ‚è½½ DMG
        echo "æŒ‚è½½ DMG æ–‡ä»¶..."
        VOLUME_PATH=$(hdiutil attach "$ANYDESK_DMG" | grep -o '/Volumes/.*' | head -n 1)
        
        # å®‰è£…åˆ° Applications
        echo "æ­£åœ¨å®‰è£…..."
        sudo cp -R "$VOLUME_PATH/AnyDesk.app" /Applications/

        # å¸è½½ DMG
        echo "å¸è½½ DMG..."
        hdiutil detach "$VOLUME_PATH"
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm "$ANYDESK_DMG"
        
        # éªŒè¯å®‰è£…ï¼ˆå³ä½¿å¤±è´¥ä¹Ÿä¸é€€å‡ºï¼‰
        echo "éªŒè¯å®‰è£…..."
        if [ -d "/Applications/AnyDesk.app" ]; then
          echo "âœ… AnyDesk å®‰è£…æˆåŠŸï¼"
          echo "åº”ç”¨ç¨‹åºä½ç½®: /Applications/AnyDesk.app"
        else
          echo "âŒ å®‰è£…å¤±è´¥ï¼Œä½†å·²å¿½ç•¥é”™è¯¯ï¼"
        fi
        
        # echo "å¯åŠ¨ AnyDesk..."
        # open /Applications/AnyDesk.app
      continue-on-error: true  # å‘Šè¯‰ GitHub Actions å¿½ç•¥æ­¤æ­¥éª¤çš„å¤±è´¥

    - name: MacOS System running...
      uses: mxschmitt/action-tmate@v2