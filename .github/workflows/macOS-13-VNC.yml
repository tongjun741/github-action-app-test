name: macOS-13-VNC
on: 
  workflow_dispatch:
jobs:
  build:
    name: macOS-13-VNC
    runs-on: macos-13
    
    steps:
    - uses: actions/checkout@v4 

    - name: Enabling Remote Access
      run: |
          chmod +x ./macOS_VNC/start.sh
          sudo ./macOS_VNC/start.sh

    - name: 启动frpc
      run: |
        sed -i "" "s/user = .*/user = ${{ secrets.FRPC_USER }}/g" macOS_VNC/frpc_15897721.ini
        sed -i "" "s/remote_port = .*/remote_port = ${{ secrets.FRPC_MAC_REMOTE_PORT }}/g" macOS_VNC/frpc_15897721.ini
        sed -i "" "s/local_port = .*/local_port = 8080/g" macOS_VNC/frpc_15897721.ini

        # 从https://www.natfrp.com/cgi/v4/system/clients提取最新的下载链接
        # 1. 下载 Natfrp 客户端 JSON 数据
        echo "🔍 正在下载 JSON 数据..."
        curl -sSfL "https://www.natfrp.com/cgi/v4/system/clients" -o natfrp_clients.json \
          || { echo "❌ 下载失败！请检查网络或链接有效性"; exit 1; }

        # 2. 解析
        echo "📊 正在解析 URL..."
        FRPC_URL=$(jq -r '.frpc.archs.darwin_amd64.url' natfrp_clients.json)

        # 3. 验证解析结果
        if [ -z "$FRPC_URL" ] || [ "$FRPC_URL" == "null" ]; then
          echo "❌ 解析失败！未找到对应的 URL";
          rm -f natfrp_clients.json  # 清理临时文件
          exit 1;
        fi

        # 4. 输出结果并验证 URL 可访问性
        echo -e "\n✅ 成功提取 URL：\n$FRPC_URL"

        curl -Lo frpc "$FRPC_URL"
        chmod +x frpc
        ./frpc -c ./macOS_VNC/frpc_15897721.ini > /tmp/frpc.log 2>&1 &
          
    - name: Install node dependencies 👨🏻‍💻
      run: yarn add ws express sharp pngjs

    - name: Install cliclick
      run: brew install cliclick

    - name: 启动ws远程桌面
      run: |
        node ./macOS_VNC/screenShareServer.js > /tmp/screenShareServer.log 2>&1 &
        
    - name: Install AnyDesk
      run: |
        #!/bin/bash
        
        echo "开始安装 AnyDesk..."
        
        # 下载 AnyDesk
        echo "正在下载 AnyDesk..."
        ANYDESK_DMG="anydesk.dmg"
        curl -L -o "$ANYDESK_DMG" "https://download.anydesk.com/anydesk.dmg"
        
        # 挂载 DMG
        echo "挂载 DMG 文件..."
        VOLUME_PATH=$(hdiutil attach "$ANYDESK_DMG" | grep -o '/Volumes/.*' | head -n 1)
        
        # 安装到 Applications
        echo "正在安装..."
        sudo cp -R "$VOLUME_PATH/AnyDesk.app" /Applications/

        # 卸载 DMG
        echo "卸载 DMG..."
        hdiutil detach "$VOLUME_PATH"
        
        # 清理临时文件
        rm "$ANYDESK_DMG"
        
        # 验证安装（即使失败也不退出）
        echo "验证安装..."
        if [ -d "/Applications/AnyDesk.app" ]; then
          echo "✅ AnyDesk 安装成功！"
          echo "应用程序位置: /Applications/AnyDesk.app"
        else
          echo "❌ 安装失败，但已忽略错误！"
        fi
        
        echo "启动 AnyDesk..."
        open /Applications/AnyDesk.app
      continue-on-error: true  # 告诉 GitHub Actions 忽略此步骤的失败

    - name: MacOS System running...
      uses: mxschmitt/action-tmate@v2