name: Ubuntu

on:
  repository_dispatch:
    types: [linux-start]
    
  workflow_dispatch:
    inputs:
      software_download_url:
        description: 'Download url'
        required: true
        default: 'https://dl.szdamai.com/downloads/ubuntu_app_zh/HuaYoungApp_Ubuntu_10.0.533_zh_setup.deb'
      in_dev:
        description: 'æ˜¯å¦æ˜¯æµ‹è¯•ç¯å¢ƒ'
        default: 'false'

jobs:

  Ubuntu:
    runs-on: ubuntu-latest

    steps:
      - name: Install Chinese fonts
        run: |
          sudo apt update
          sudo apt install -y fonts-wqy-zenhei

      - uses: actions/checkout@v4
      
      - name: Install libnotify4
        run: sudo apt-get update && sudo apt-get install -y libnotify4 xvfb desktop-file-utils

      - name: Download file with curl
        run: |
          if [ -z "${{ inputs.software_download_url }}" ]; then
            download_url="https://dl.szdamai.com/downloads/ubuntu_app_zh/HuaYoungApp_Ubuntu_10.0.533_zh_setup.deb"
          else
            download_url="${{ inputs.software_download_url }}"
          fi
          curl -o /tmp/HuaYoungApp_Ubuntu_setup.deb $download_url

      - name: Installation
        run: sudo dpkg -i /tmp/HuaYoungApp_Ubuntu_setup.deb

      - name: Start X DISPLAY
        run: |
          sudo Xvfb -ac :99 -screen 0 1280x1024x24 > /dev/null 2>&1 &

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          #cache: 'yarn'
          
      - name: Install dependencies ğŸ‘¨ğŸ»â€ğŸ’»
        run: yarn

      - name: å‡†å¤‡chromedriver
        run: |
          mkdir -p /tmp/chromedriver/linux-108/chromedriver-linux64
          cd /tmp/chromedriver/linux-108/chromedriver-linux64
          wget https://chromedriver.storage.googleapis.com/108.0.5359.22/chromedriver_linux64.zip
          unzip chromedriver_linux64.zip
          cd -

      - name: è‡ªåŠ¨åˆ›å»ºå·¥ä½œç›®å½•
        run: |
          mkdir -p ~/.config/HuaYoung
      
      # - name: Setup tmate session
      #   uses: mxschmitt/action-tmate@v3

      - name: E2E Test for Electron ğŸ§ª
        env:
          DEV_WDIO_PASSWORD: ${{ secrets.DEV_WDIO_PASSWORD }}
          PRODUCT_WDIO_PASSWORD: ${{ secrets.PRODUCT_WDIO_PASSWORD }}
          DOWNLOAD_URL: ${{ github.event.inputs.software_download_url }}
          IN_DEV: ${{ github.event.inputs.in_dev }}
          FEISHU_TOKEN: ${{ secrets.FEISHU_TOKEN }}
          FEISHU_ME: ${{ secrets.FEISHU_ME }}
          LOGGER_SERVER: ${{ secrets.LOGGER_SERVER }}
          TRANSITER_SH_SERVER: ${{ secrets.TRANSITER_SH_SERVER }}
        run: |
          sudo chmod a+w /opt/èŠ±æ¼¾å®¢æˆ·ç«¯/resources/app.asar
          sudo node modifyMain.js
          DISPLAY=:99 yarn wdio
