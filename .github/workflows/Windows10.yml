name: Windows10

on:
  repository_dispatch:
    types: [win10-start]
    
  workflow_dispatch:
    inputs:
      software_download_url:
        description: 'Download url'
        required: true
        default: 'https://dl.szdamai.com/downloads/win10_app_zh/HuaYoungApp_Win10_10.0.648_zh_setup.exe'
      do_wdio:
        description: 'æ˜¯å¦æ‰§è¡Œ WDIO æµ‹è¯•'
        default: ''
      do_ip_test:
        description: 'æ˜¯å¦æ‰§è¡Œ IP æµ‹è¯•'
        default: 'true'
        
  schedule:
    - cron: '5 * * * *'  # åŒ—äº¬æ—¶é—´æ¯å¤©å‡Œæ™¨3ç‚¹ï¼ˆUTCæ—¶é—´19ç‚¹ï¼‰

jobs:

  Windows10:
    runs-on: windows-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          #cache: 'yarn'
          
      - name: Install dependencies ğŸ‘¨ğŸ»â€ğŸ’»
        run: yarn

      - name: List files in directory1
        run: |
          Write-Output $PWD
          Get-ChildItem -Path "$PWD"

      - name: Install your_software
        run: |
          Invoke-WebRequest -Uri "${{ github.event.inputs.software_download_url || 'https://dl.szdamai.com/downloads/win10_app_zh/HuaYoungApp_Win10_10.0.648_zh_setup.exe' }}" -OutFile "$env:TEMP\your_software_installer.exe"
          Start-Process -FilePath "$env:TEMP\your_software_installer.exe" -ArgumentList "/S" -Wait

      - name: List files in your_software
        run: |
          Get-ChildItem -Path "$env:LOCALAPPDATA\Programs"

      - name: Check installation success
        run: |
          Test-Path "$env:LOCALAPPDATA\Programs\HuaYoung\èŠ±æ¼¾å®¢æˆ·ç«¯.exe"  # æ£€æŸ¥å®‰è£…ç›®å½•æ˜¯å¦å­˜åœ¨

      - name: Install webdriver
        run: |
          Invoke-WebRequest -Uri "https://chromedriver.storage.googleapis.com/108.0.5359.71/chromedriver_win32.zip" -OutFile "$env:TEMP\chromedriver_win32.zip"
          
      - name: Unzip webdriver
        run: Expand-Archive -Path "$env:TEMP\chromedriver_win32.zip" -DestinationPath "$env:TEMP\chromedriver\win64-108\chromedriver-win64"

      - name: List files in directory2
        run: |
          Get-ChildItem -Path "$env:TEMP\chromedriver\win64-108"

      - name: List files in directory3
        run: |
          Write-Output $PWD
          Get-ChildItem -Path "$PWD"

      - name: E2E Test for Electron ğŸ§ª
        if: ${{ contains(inputs.do_wdio, 'true') }}
        env:
          PRODUCT_WDIO_PASSWORD: ${{ secrets.PRODUCT_WDIO_PASSWORD }}
        run: yarn wdio

      - name: IPæµ‹è¯•
        if: ${{ !contains(inputs.do_ip_test, 'false') }}
        env:
          PRODUCT_IP_TEST_PASSWORD: ${{ secrets.PRODUCT_IP_TEST_PASSWORD }}
        run: node tests\ipTest.js
