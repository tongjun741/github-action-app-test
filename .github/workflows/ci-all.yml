name: CI

on: [push]

jobs:

  Windows10:
    runs-on: windows-latest
    
    if: ${{ github.event_name == 'pull_request111' && github.event.action == 'unassigned111' }}

    steps:
      - uses: actions/checkout@v2

      - name: Use Node.js 20
        uses: actions/setup-node@v2
        with:
          node-version: 20
          #cache: 'yarn'
          
      - name: Install dependencies ğŸ‘¨ğŸ»â€ğŸ’»
        run: yarn

      - name: List files in directory1
        run: |
          Write-Output $PWD
          Get-ChildItem -Path "$PWD"

      - name: Install your_software
        run: |
          Invoke-WebRequest -Uri "https://dl.szdamai.com/downloads/win10_app_zh/HuaYoungApp_Win10_8.2.540_zh_setup.exe" -OutFile "$env:TEMP\your_software_installer.exe"
          Start-Process -FilePath "$env:TEMP\your_software_installer.exe" -ArgumentList "/S" -Wait

      - name: List files in your_software
        run: |
          Get-ChildItem -Path "$env:LOCALAPPDATA\Programs"

      - name: Check installation success
        run: |
          Test-Path "$env:LOCALAPPDATA\Programs\HuaYoung\èŠ±æ¼¾å®¢æˆ·ç«¯.exe"  # æ£€æŸ¥å®‰è£…ç›®å½•æ˜¯å¦å­˜åœ¨

      - name: Install webdriver
        run: |
          Invoke-WebRequest -Uri "https://chromedriver.storage.googleapis.com/108.0.5359.71/chromedriver_win32.zip" -OutFile "$env:TEMP\chromedriver_win32.zip"
          
      - name: Unzip webdriver
        run: Expand-Archive -Path "$env:TEMP\chromedriver_win32.zip" -DestinationPath "$env:TEMP\chromedriver\win64-108.0.5359.215\chromedriver-win64"

      - name: List files in directory2
        run: |
          Get-ChildItem -Path "$env:TEMP\chromedriver\win64-108.0.5359.215"

      - name: List files in directory3
        run: |
          Write-Output $PWD
          Get-ChildItem -Path "$PWD"

      - name: E2E Test for Electron ğŸ§ª
        run: yarn wdio

  Ubuntu:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      
      - name: Install libnotify4
        run: sudo apt-get update && sudo apt-get install -y libnotify4 xvfb
              
      - name: Download file with curl
        run: curl -o /tmp/HuaYoungApp_Ubuntu_setup.deb https://dl.szdamai.com/downloads/ubuntu_app_zh/HuaYoungApp_Ubuntu_8.2.445_zh_setup.deb

      - name: Installation
        run: sudo dpkg -i /tmp/HuaYoungApp_Ubuntu_setup.deb

      - name: Start software
        run: run: |
          export DISPLAY=:99
          sudo Xvfb -ac :99 -screen 0 1280x1024x24 > /dev/null 2>&1 

      - name: Use Node.js 20
        uses: actions/setup-node@v2
        with:
          node-version: 20
          #cache: 'yarn'
          
      - name: Install dependencies ğŸ‘¨ğŸ»â€ğŸ’»
        run: yarn

      - name: E2E Test for Electron ğŸ§ª
        run: yarn wdio

  macOS:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v2
      
      - name: Download file with curl
        run: curl -o /tmp/HuaYoungApp_Mac_setup.dmg https://dl.szdamai.com/downloads/mac_app_zh/HuaYoungApp_Mac_8.2.445_zh_setup.dmg

      - name: Install software
        run: |
          hdiutil attach /tmp/HuaYoungApp_Mac_setup.dmg
          ls -l /Volumes/
          sudo cp -R '/Volumes/èŠ±æ¼¾å®¢æˆ·ç«¯ 8.2.445/èŠ±æ¼¾å®¢æˆ·ç«¯.app' /Applications/
          hdiutil detach '/Volumes/èŠ±æ¼¾å®¢æˆ·ç«¯ 8.2.445/'

      # - name: Start software
      #   run: |
      #     open /Applications/èŠ±æ¼¾å®¢æˆ·ç«¯.app

      - name: Use Node.js 20
        uses: actions/setup-node@v2
        with:
          node-version: 20
          #cache: 'yarn'
          
      - name: Install dependencies ğŸ‘¨ğŸ»â€ğŸ’»
        run: yarn

      - name: E2E Test for Electron ğŸ§ª
        run: yarn wdio