name: CrxTest

on:
  repository_dispatch:
    types: [crx-test]
    
  workflow_dispatch:
    inputs:
      crx_download_url:
        description: 'Download url'
      in_dev:
        description: 'æ˜¯å¦æ˜¯æµ‹è¯•ç¯å¢ƒ'
        default: 'false'
      debug:
        description: 'æ˜¯å¦å¼€å¯è°ƒè¯•'
        default: 'false'

jobs:

  Windows10:
    runs-on: windows-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'yarn'
          
      - name: Install dependencies ğŸ‘¨ğŸ»â€ğŸ’»
        run: yarn

      - uses: browser-actions/setup-chrome@v2
        with:
          chrome-version: 141

      - name: å®‰è£…æ’ä»¶
        run: |
          # æ£€æŸ¥æ˜¯å¦æä¾›äº†ä¸‹è½½ URL
          if ( -not "${{ github.event.inputs.software_download_url }}" ) {
            # æ²¡æœ‰æä¾› URLï¼Œä½¿ç”¨å›ºå®šçš„é“¾æ¥
            $downloadUrl = "https://dl.szdamai.com/downloads/files/tkshop-crx-1.5.6.zip"
            Write-Host "Generated download URL: $downloadUrl"
          } else {
            # ä½¿ç”¨æä¾›çš„ä¸‹è½½ URL
            $downloadUrl = "${{ github.event.inputs.crx_download_url }}"
            Write-Host "Using provided download URL: $downloadUrl"
          }

          # ä¸‹è½½æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
          Invoke-WebRequest -Uri $downloadUrl -OutFile "$env:TEMP\crx.zip"
          
          # è§£å‹åˆ°å½“å‰å·¥ä½œç›®å½•ï¼ˆGitHub Actions ä¸­é»˜è®¤æ˜¯ä»“åº“æ ¹ç›®å½•ï¼‰
          Expand-Archive -Path "$env:TEMP\crx.zip" -DestinationPath "tkshop-crx" -Force
          
          # æ‰“å°å½“å‰ç›®å½•è·¯å¾„
          Write-Host "å½“å‰ç›®å½•è·¯å¾„: $(Get-Location)"
          
          # æ‰“å°å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å’Œæ–‡ä»¶å¤¹
          Write-Host "`nå½“å‰ç›®å½•ä¸‹çš„æ–‡ä»¶åˆ—è¡¨:"
          Get-ChildItem -Path . | Format-Table -AutoSize

      - name: Enable TS
        if: ${{ contains(inputs.debug, 'true') }}
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server'-name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 1
          Set-LocalUser -Name "runneradmin" -Password (ConvertTo-SecureString -AsPlainText "P@ssw0rd!" -Force)

      - name: ä¿®æ”¹åˆ†è¾¨ç‡ä¸º1920*1080
        run: |
          Set-DisplayResolution -Width 1920 -Height 1080 -Force

      - name: å¯åŠ¨frpc
        if: ${{ contains(inputs.debug, 'true') }}
        run: |
          (Get-Content macOS_VNC/frpc_15897721.ini) -replace "user = .*", "user = $env:FRPC_USER" | Set-Content macOS_VNC/frpc_15897721.ini
          (Get-Content macOS_VNC/frpc_15897721.ini) -replace "remote_port = .*", "remote_port = $env:FRPC_MAC_REMOTE_PORT" | Set-Content macOS_VNC/frpc_15897721.ini
          (Get-Content macOS_VNC/frpc_15897721.ini) -replace "local_port = .*", "local_port = 3389" | Set-Content macOS_VNC/frpc_15897721.ini
          Invoke-WebRequest -Uri "https://nya.globalslb.net/natfrp/client/frpc/0.51.0-sakura-12.3/frpc_windows_amd64.exe" -OutFile "frpc.exe"
          ./frpc.exe -c macOS_VNC/frpc_15897721.ini
        env:
          FRPC_USER: ${{ secrets.FRPC_USER }}
          FRPC_MAC_REMOTE_PORT: ${{ secrets.FRPC_MAC_REMOTE_PORT }}

      - name: æ‰§è¡Œæµ‹è¯•
        env:
          E2E_PLATFORM: "Windows 10"
          DEV_WDIO_PASSWORD: ${{ secrets.DEV_WDIO_PASSWORD }}
          PRODUCT_WDIO_PASSWORD: ${{ secrets.PRODUCT_WDIO_PASSWORD }}
          DOWNLOAD_URL: ${{ github.event.inputs.crx_download_url }}
          IN_DEV: ${{ github.event.inputs.in_dev }}
          FEISHU_TOKEN: ${{ secrets.FEISHU_TOKEN }}
          FEISHU_ME: ${{ secrets.FEISHU_ME }}
          LOGGER_SERVER: ${{ secrets.LOGGER_SERVER }}
          TRANSITER_SH_SERVER: ${{ secrets.TRANSITER_SH_SERVER }}
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          CLOUDINARY_URL: ${{ secrets.CLOUDINARY_URL }}
          CLOUDINARY_MASK: ${{ secrets.CLOUDINARY_MASK }}
        run: yarn add chromedriver@141 --dev && node tests\crxTest.js